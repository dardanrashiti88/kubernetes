name: Simple K8s Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Check secret exists
      run: |
        echo "Checking KUBECONFIG_B64 secret..."
        if [ -z "${{ secrets.KUBECONFIG_B64 }}" ]; then
          echo "❌ ERROR: KUBECONFIG_B64 secret is not set or is empty!"
          echo "Please go to your repository Settings → Secrets and variables → Actions"
          echo "Add a secret named 'KUBECONFIG_B64' with your base64-encoded kubeconfig"
          exit 1
        fi
        echo "✅ KUBECONFIG_B64 secret is set"

    - name: Setup kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        
        echo "Kubeconfig file created:"
        ls -la $HOME/.kube/
        
        echo "File size:"
        wc -c $HOME/.kube/config
        
        echo "First few lines of kubeconfig:"
        head -5 $HOME/.kube/config

    - name: Debug kubeconfig
      run: |
        echo "=== KUBECONFIG FILE CONTENTS ==="
        cat $HOME/.kube/config
        echo "=== END KUBECONFIG ==="
        
        echo "Current kubectl context:"
        kubectl config current-context || echo "No context set"
        
        echo "Available contexts:"
        kubectl config get-contexts || echo "No contexts found"
        
        echo "Cluster info:"
        kubectl config view --minify || echo "Cannot view config"

    - name: Test connection
      run: kubectl get nodes

    - name: Deploy to cluster
      run: kubectl apply -f k8s/
